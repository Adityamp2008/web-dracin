<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cineverse Mobile Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    colors: { primary: '#FF3B30', surface: '#000000' },
                    fontFamily: { sans: ['Space Grotesk', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000; color: white; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .glass-nav { background: rgba(0,0,0,0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .card-anim { transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .card-anim:active { transform: scale(0.95); }
        
        /* --- FIX 1: PAKAI DVH BIAR PAS DI BROWSER HP --- */
        .reels-container { 
            scroll-snap-type: y mandatory; 
            overflow-y: scroll; 
            height: 100dvh; /* Dynamic Height */
            width: 100vw; 
            background: #000; 
            scroll-behavior: smooth; 
        }
        .reel-item { 
            scroll-snap-align: start; 
            height: 100dvh; /* Dynamic Height */
            width: 100vw; 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background: #000; 
        }

        .loader { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #FF3B30; border-radius: 50%; animation: rotation 0.8s ease-in-out infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- IMMERSIVE UI --- */
        .player-overlay { 
            position: absolute; inset: 0; pointer-events: none;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.9) 100%);
            opacity: 1; transition: opacity 0.5s ease-in-out;
            height: 100dvh; /* Fix tinggi overlay */
        }
        .player-overlay.clean-mode { opacity: 0; }

        /* --- FIX 2: POSISI KONTROL LEBIH TINGGI (ANTI KETUTUP) --- */
        
        /* Progress Bar & Waktu */
        .progress-area {
            position: absolute; 
            bottom: calc(18% + env(safe-area-inset-bottom)); /* Naik sekitar 18% dari bawah */
            left: 20px; right: 20px;
            pointer-events: none; opacity: 1; transition: transform 0.3s;
            z-index: 55;
        }
        .player-overlay.clean-mode .progress-area { transform: translateY(20px); }

        /* Tombol Kapsul Play/Next */
        .control-capsule {
            position: absolute; 
            bottom: calc(8% + env(safe-area-inset-bottom)); /* Naik 8% + Safe Area iPhone */
            left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.75); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 999px;
            padding: 8px 14px; display: flex; align-items: center; gap: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); pointer-events: auto; z-index: 55;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .player-overlay.clean-mode .control-capsule { transform: translate(-50%, 80px); }

        .time-text { font-size: 11px; font-weight: 700; color: #ddd; margin-bottom: 8px; font-variant-numeric: tabular-nums; text-shadow: 0 2px 4px rgba(0,0,0,0.8); letter-spacing: 0.5px; }
        .prog-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 4px; overflow: hidden; backdrop-filter: blur(4px); }
        .prog-fill { height: 100%; background: #FF3B30; width: 0%; transition: width 0.1s linear; box-shadow: 0 0 15px rgba(255, 59, 48, 0.9); }

        .btn-capsule { color: rgba(255,255,255,0.8); font-size: 20px; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .btn-capsule:active { color: white; background: rgba(255,255,255,0.2); transform: scale(0.9); }
        
        .btn-play-main { width: 55px; height: 55px; background: white; color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 0 20px rgba(255,255,255,0.2); transition: all 0.2s; }
        .btn-play-main:active { transform: scale(0.9); box-shadow: 0 0 5px rgba(255,255,255,0.1); }

        /* HEADER INFO (Top Area) */
        .header-info { 
            position: absolute; 
            top: calc(20px + env(safe-area-inset-top)); /* Jarak dari atas aman */
            left: 20px; pointer-events: auto; max-width: 55%; 
            transition: transform 0.3s; 
        }
        .player-overlay.clean-mode .header-info { transform: translateY(-20px); }

        .top-controls { 
            position: absolute; 
            top: calc(20px + env(safe-area-inset-top)); 
            right: 20px; 
            display: flex; flex-direction: column; gap: 8px; align-items: flex-end; 
            transition: transform 0.3s; pointer-events: auto; 
        }
        .player-overlay.clean-mode .top-controls { transform: translateY(-20px); }

        .qual-badge { font-size: 10px; font-weight: 800; padding: 6px 12px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; cursor: pointer; color: #fff; display: flex; align-items: center; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .qual-badge.active { border-color: #4ade80; color: #4ade80; background: rgba(74, 222, 128, 0.1); }

        .quality-popup { position: absolute; top: 45px; right: 0; background: rgba(20,20,20,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; display: flex; flex-col; opacity: 0; transform: scale(0.9); pointer-events: none; transition: all 0.2s; z-index: 60; width: 90px; backdrop-filter: blur(10px); }
        .quality-popup.show { opacity: 1; transform: scale(1); pointer-events: auto; }
        .q-item { padding: 12px; font-size: 12px; font-weight: 600; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .q-item:active { background: rgba(255,255,255,0.1); color: white; }

        .speed-flash { 
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%); 
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px);
            border: 1px solid rgba(74, 222, 128, 0.3);
            padding: 6px 16px; border-radius: 30px; 
            display: flex; align-items: center; gap: 8px;
            pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 60;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .speed-flash.active { opacity: 1; }
        .speed-text { font-size: 12px; font-weight: 800; color: #4ade80; letter-spacing: 1px; }
        .speed-icon { font-size: 14px; color: #4ade80; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 0.6; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav class="fixed top-0 w-full z-50 glass-nav h-16 flex items-center">
        <div class="w-full px-4 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-black font-black italic">C</div>
                <h1 class="text-xl font-bold tracking-tight">CINE<span class="text-primary">VERSE</span></h1>
            </div>
            <div class="flex-1 mx-3">
                <input type="text" id="searchInput" placeholder="Search..." 
                    class="w-full bg-white/5 border border-white/5 text-white rounded-xl py-2 px-4 text-sm focus:border-primary focus:outline-none"
                    onkeypress="if(event.key==='Enter') doSearch(this.value)">
            </div>
        </div>
    </nav>

    <main class="pt-20 pb-24 px-3 min-h-screen">
        <h2 id="pageTitle" class="text-2xl font-bold mb-5 tracking-tight">Discover</h2>
        <div id="contentGrid" class="grid grid-cols-3 gap-3"></div>
        <div id="mainLoader" class="flex justify-center mt-20"><div class="loader"></div></div>
    </main>

    <div id="detailModal" class="fixed inset-0 z-[60] bg-black hidden flex flex-col overflow-y-auto animate-fade-in">
        <div class="relative h-[55vh] w-full shrink-0">
            <img id="detailCover" src="" class="w-full h-full object-cover opacity-80">
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
            <button onclick="closeDetail()" class="absolute top-4 left-4 z-20 w-10 h-10 bg-white/10 backdrop-blur rounded-full text-white flex items-center justify-center active:scale-90 transition"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="absolute bottom-0 left-0 right-0 p-6 pb-14">
                <h1 id="detailTitle" class="text-3xl font-black leading-tight mb-2 text-shadow-lg drop-shadow-md">Title</h1>
                <div class="flex items-center gap-3">
                    <span id="scanStatus" class="text-xs font-bold text-primary bg-primary/20 px-2 py-1 rounded tracking-widest uppercase border border-primary/30">SCANNING</span>
                </div>
            </div>
        </div>
        <div class="flex-1 bg-surface px-4 py-6 min-h-[50vh] rounded-t-3xl -mt-6 relative z-10 border-t border-white/10 shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-white text-lg">Episodes</h3>
                <button onclick="forceDeepScan()" class="text-xs font-bold text-gray-500 hover:text-white transition"><i class="fa-solid fa-rotate-right"></i> RELOAD</button>
            </div>
            <div id="epGrid" class="grid grid-cols-5 gap-3 pb-32"></div>
        </div>
    </div>

    <div id="reelsModal" class="fixed inset-0 z-[100] bg-black hidden">
        <div id="reelsContainer" class="reels-container"></div>
        <button onclick="closeReels()" class="absolute top-4 left-4 z-[110] w-10 h-10 bg-black/20 backdrop-blur rounded-full text-white flex items-center justify-center pointer-events-auto border border-white/10">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <script>
        const API_BASE = "https://api.dramaku.biz.id";
        let currentChapters = [];
        let currentMeta = {};
        let reelsObserver = null;
        let hls = null;
        let isAutoScroll = true;

        document.addEventListener('DOMContentLoaded', () => { loadHome(); initObserver(); });

        async function fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("HTTP Error");
                    return await res.json();
                } catch (e) {
                    if (i === retries - 1) return null;
                    await new Promise(r => setTimeout(r, 500));
                }
            }
        }

        async function fetchHybridX(bookId) {
            const statusEl = document.getElementById('scanStatus');
            const uniqueMap = new Map();
            const ts = Date.now();
            statusEl.innerText = "SYNCING DATA...";
            const fetchA = fetchWithRetry(`${API_BASE}/download/${bookId}?_t=${ts}`).then(j => {
                if (j && j.success && j.data) j.data.forEach(d => uniqueMap.set(parseInt(d.chapterIndex||d.chapterNo||0), {...d, isPremium:true}));
            });
            const fetchB = (async () => {
                const requests = [];
                for (let i = 1; i <= 15; i++) {
                    requests.push(fetchWithRetry(`${API_BASE}/api/chapters/${bookId}?page=${i}&size=10&_t=${ts}`).then(j => j?.data || []));
                }
                const pages = await Promise.all(requests);
                pages.forEach(p => p.forEach(d => {
                    const k = parseInt(d.chapterIndex||d.chapterNo||0);
                    if(!uniqueMap.has(k)) uniqueMap.set(k, d);
                }));
            })();
            await Promise.all([fetchA, fetchB]);
            const finalArr = Array.from(uniqueMap.values()).sort((a,b)=>(parseInt(a.chapterIndex||a.chapterNo||0)-parseInt(b.chapterIndex||b.chapterNo||0)));
            statusEl.innerText = `${finalArr.length} EPISODES FOUND`;
            return finalArr;
        }

        function getAllQualities(chapter) {
            let qualities = [];
            if (chapter.cdnList && chapter.cdnList.length > 0) {
                const cdn = chapter.cdnList.find(c => c.isDefault) || chapter.cdnList[0];
                if (cdn && cdn.videoPathList) qualities = cdn.videoPathList.map(v => ({ q: v.quality, url: v.videoPath }));
            }
            if (qualities.length === 0 && chapter.videoPath) qualities.push({ q: 'SD', url: chapter.videoPath });
            return qualities.sort((a, b) => (typeof b.q==='number'?b.q:0) - (typeof a.q==='number'?a.q:0));
        }

        async function openDetail(id, title, cover) {
            currentMeta = { id, title, cover };
            document.getElementById('detailCover').src = cover;
            document.getElementById('detailTitle').innerText = title;
            document.getElementById('epGrid').innerHTML = "";
            document.getElementById('detailModal').classList.remove('hidden');
            const chapters = await fetchHybridX(id);
            renderChapters(chapters);
        }

        function forceDeepScan() { openDetail(currentMeta.id, currentMeta.title, currentMeta.cover); }

        function renderChapters(chapters) {
            currentChapters = chapters;
            const grid = document.getElementById('epGrid');
            grid.innerHTML = "";
            if (chapters.length === 0) { grid.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-10">No Data</div>`; return; }
            chapters.forEach((chap, idx) => {
                const btn = document.createElement('button');
                btn.className = "bg-white/5 border border-white/5 rounded-xl py-4 text-sm font-bold text-gray-200 hover:bg-white hover:text-black transition active:scale-95";
                btn.innerText = idx + 1;
                btn.onclick = () => startReels(idx);
                grid.appendChild(btn);
            });
        }

        function startReels(startIdx) {
            const container = document.getElementById('reelsContainer');
            container.innerHTML = "";
            currentChapters.forEach((_, idx) => {
                const div = document.createElement('div');
                div.className = "reel-item";
                div.id = `slide-${idx}`;
                div.dataset.index = idx;
                div.innerHTML = `<div class="loader"></div>`;
                container.appendChild(div);
            });
            document.getElementById('reelsModal').classList.remove('hidden');
            setTimeout(() => {
                const startEl = document.getElementById(`slide-${startIdx}`);
                if(startEl) document.getElementById('reelsContainer').scrollTo({ top: startEl.offsetTop, behavior: 'auto' });
                document.querySelectorAll('.reel-item').forEach(el => reelsObserver.observe(el));
            }, 100);
        }

        function initObserver() {
            reelsObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) loadVideo(entry.target, parseInt(entry.target.dataset.index));
                    else {
                        const v = entry.target.querySelector('video');
                        if (v) { if (hls) hls.destroy(); v.pause(); v.remove(); }
                    }
                });
            }, { threshold: 0.6 });
        }

        function formatTime(seconds) {
            if(isNaN(seconds)) return "00:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }

        function loadVideo(el, idx) {
            const chap = currentChapters[idx];
            const qualities = getAllQualities(chap);
            let defaultVid = qualities.find(x => x.q === 720) || qualities[0];

            if (!defaultVid) { el.innerHTML = `<div class="text-center text-gray-500">Error</div>`; return; }

            const isFirst = idx === 0;
            const isLast = idx === currentChapters.length - 1;
            let menuHtml = '';
            qualities.forEach(q => { menuHtml += `<div class="q-item" onclick="switchQuality(${idx}, '${q.url}', '${q.q}')">${q.q}p</div>`; });

            el.innerHTML = `
                <div class="w-full h-full relative group bg-black">
                    <video id="vid-${idx}" class="w-full h-full object-contain" playsinline></video>
                    
                    <div id="flash-${idx}" class="speed-flash"><i class="fa-solid fa-forward speed-icon"></i> <span class="speed-text">2X</span></div>
                    <div id="gesture-${idx}" class="absolute inset-0 z-0"></div>

                    <div id="overlay-${idx}" class="player-overlay pointer-events-none">
                        <div class="header-info">
                            <h3 class="font-bold text-lg leading-tight text-white drop-shadow-md mb-1 line-clamp-1">${currentMeta.title}</h3>
                            <p class="text-sm font-medium text-gray-300">Episode ${idx+1}</p>
                        </div>

                        <div class="top-controls">
                            <button id="btn-auto-${idx}" onclick="toggleAutoScroll(${idx})" class="qual-badge ${isAutoScroll ? 'active' : ''}"><i class="fa-solid fa-infinity"></i> ${isAutoScroll ? 'Auto: ON' : 'Auto: OFF'}</button>
                            <button id="btn-speed-${idx}" onclick="toggleSpeedManual(${idx})" class="qual-badge">1.0x</button>
                            <div class="relative">
                                <button onclick="toggleQualMenu(${idx})" class="qual-badge"><span id="label-qual-${idx}">${defaultVid.q}p</span> <i class="fa-solid fa-chevron-down text-[8px]"></i></button>
                                <div id="menu-qual-${idx}" class="quality-popup">${menuHtml}</div>
                            </div>
                        </div>

                        <div class="progress-area">
                            <div id="time-${idx}" class="time-text">00:00 / 00:00</div>
                            <div class="prog-track"><div id="prog-${idx}" class="prog-fill"></div></div>
                        </div>

                        <div class="control-capsule">
                            <button class="btn-capsule" onclick="prevEp(${idx})" ${isFirst?'style="opacity:0.3"':''}><i class="fa-solid fa-backward-step"></i></button>
                            <button id="btn-play-${idx}" class="btn-play-main" onclick="togglePlay('vid-${idx}')"><i class="fa-solid fa-pause"></i></button>
                            <button class="btn-capsule" onclick="nextEp(${idx})" ${isLast?'style="opacity:0.3"':''}><i class="fa-solid fa-forward-step"></i></button>
                        </div>
                    </div>
                </div>
            `;

            const vid = document.getElementById(`vid-${idx}`);
            const gesture = document.getElementById(`gesture-${idx}`);
            const flash = document.getElementById(`flash-${idx}`);
            const overlay = document.getElementById(`overlay-${idx}`);
            const playBtn = document.getElementById(`btn-play-${idx}`);
            const timeTxt = document.getElementById(`time-${idx}`);
            const progFill = document.getElementById(`prog-${idx}`);

            playHls(vid, defaultVid.url);

            vid.addEventListener('timeupdate', () => {
                const cur = vid.currentTime; const dur = vid.duration || 0;
                progFill.style.width = `${(cur/dur)*100}%`;
                timeTxt.innerText = `${formatTime(cur)} / ${formatTime(dur)}`;
            });

            vid.addEventListener('ended', () => {
                if (isAutoScroll) { setTimeout(() => nextEp(idx), 500); } 
                else { playBtn.innerHTML = '<i class="fa-solid fa-rotate-right"></i>'; overlay.classList.remove('clean-mode'); }
            });

            let idleTimer;
            function showControls() {
                overlay.classList.remove('clean-mode');
                clearTimeout(idleTimer);
                if (!vid.paused) { idleTimer = setTimeout(() => { overlay.classList.add('clean-mode'); }, 3000); }
            }

            gesture.addEventListener('click', showControls);
            vid.addEventListener('play', () => { playBtn.innerHTML = '<i class="fa-solid fa-pause"></i>'; showControls(); });
            vid.addEventListener('pause', () => { playBtn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>'; overlay.classList.remove('clean-mode'); clearTimeout(idleTimer); });

            let pressTimer;
            const startSpeed = (e) => {
                if(e.target.closest('button') || e.target.closest('.quality-popup')) return;
                pressTimer = setTimeout(() => { vid.playbackRate = 2.0; flash.classList.add('active'); }, 200);
            };
            const endSpeed = () => { clearTimeout(pressTimer); if(document.getElementById(`btn-speed-${idx}`).innerText !== "2.0x") vid.playbackRate = 1.0; flash.classList.remove('active'); };

            gesture.addEventListener('touchstart', startSpeed, {passive:true});
            gesture.addEventListener('touchend', endSpeed);
            gesture.addEventListener('mousedown', startSpeed);
            gesture.addEventListener('mouseup', endSpeed);
            gesture.addEventListener('mouseleave', endSpeed);
            gesture.onclick = (e) => { document.getElementById(`menu-qual-${idx}`).classList.remove('show'); showControls(); };
        }

        function playHls(videoEl, url) {
            if (Hls.isSupported() && url.includes('.m3u8')) {
                if(hls) hls.destroy();
                hls = new Hls({ startLevel: -1 });
                hls.loadSource(url);
                hls.attachMedia(videoEl);
                hls.on(Hls.Events.MANIFEST_PARSED, () => videoEl.play());
            } else { videoEl.src = url; videoEl.play(); }
        }
        function toggleQualMenu(idx) { document.getElementById(`menu-qual-${idx}`).classList.toggle('show'); }
        function switchQuality(idx, url, label) {
            const vid = document.getElementById(`vid-${idx}`);
            const time = vid.currentTime; const playing = !vid.paused;
            playHls(vid, url);
            vid.currentTime = time; if(playing) vid.play();
            document.getElementById(`label-qual-${idx}`).innerText = `${label}p`;
            document.getElementById(`menu-qual-${idx}`).classList.remove('show');
        }
        function toggleAutoScroll(idx) {
            isAutoScroll = !isAutoScroll;
            const btn = document.getElementById(`btn-auto-${idx}`);
            btn.innerHTML = `<i class="fa-solid fa-infinity"></i> ${isAutoScroll ? 'Auto: ON' : 'Auto: OFF'}`;
            btn.classList.toggle('active');
        }
        function toggleSpeedManual(idx) {
            const vid = document.getElementById(`vid-${idx}`);
            const btn = document.getElementById(`btn-speed-${idx}`);
            if(vid.playbackRate === 1.0) { vid.playbackRate = 2.0; btn.innerText = "2.0x"; btn.classList.add('active'); }
            else { vid.playbackRate = 1.0; btn.innerText = "1.0x"; btn.classList.remove('active'); }
        }
        function togglePlay(id) { const v=document.getElementById(id); if(v.paused) v.play(); else v.pause(); }
        function nextEp(i) { 
            const container = document.getElementById('reelsContainer');
            const nextSlide = document.getElementById(`slide-${i+1}`);
            if (nextSlide) container.scrollTo({ top: nextSlide.offsetTop, behavior: 'smooth' });
        }
        function prevEp(i) { 
            const container = document.getElementById('reelsContainer');
            const prevSlide = document.getElementById(`slide-${i-1}`);
            if (prevSlide) container.scrollTo({ top: prevSlide.offsetTop, behavior: 'smooth' });
        }
        function closeReels() { document.getElementById('reelsModal').classList.add('hidden'); }
        function closeDetail() { document.getElementById('detailModal').classList.add('hidden'); }

        async function loadHome() {
            const d = await fetch(`${API_BASE}/api/home?page=1&size=60`).then(r=>r.json());
            const g = document.getElementById('contentGrid'); g.innerHTML="";
            d.data.forEach(i=>{
                const d = document.createElement('div');
                d.className="relative aspect-[2/3] bg-white/5 rounded-xl overflow-hidden cursor-pointer card-anim";
                d.onclick=()=>openDetail(i.bookId||i.id, i.title||i.name, i.cover||i.thumbnail);
                d.innerHTML=`<img src="${i.cover||i.thumbnail}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div><p class="absolute bottom-3 left-3 right-3 text-xs font-bold leading-tight line-clamp-2">${i.title||i.name}</p>`;
                g.appendChild(d);
            });
            document.getElementById('mainLoader').classList.add('hidden');
        }
        async function doSearch(q) {
            document.getElementById('mainLoader').classList.remove('hidden'); document.getElementById('contentGrid').innerHTML="";
            const d = await fetch(`${API_BASE}/api/search?q=${q}&keyword=${q}`).then(r=>r.json());
            document.getElementById('mainLoader').classList.add('hidden');
            const g = document.getElementById('contentGrid');
            d.data.forEach(i=>{
                const d = document.createElement('div');
                d.className="relative aspect-[2/3] bg-white/5 rounded-xl overflow-hidden cursor-pointer card-anim";
                d.onclick=()=>openDetail(i.bookId||i.id, i.title||i.name, i.cover||i.thumbnail);
                d.innerHTML=`<img src="${i.cover||i.thumbnail}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div><p class="absolute bottom-3 left-3 right-3 text-xs font-bold leading-tight line-clamp-2">${i.title||i.name}</p>`;
                g.appendChild(d);
            });
        }
    </script>
</body>
</html>